name: Deploy to Aliyun

on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯æ¨é€

jobs:
  project-prepare:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§ Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      - name: ğŸ“¤ Copy project to Aliyun
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/var/www/website-admin

      - name: ğŸ§¾ Prepare .env file on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} << 'EOF'
            cp /var/www/env/admin.env /var/www/website-admin/backend/.env
            cp /var/www/env/admin.env /var/www/website-admin/backend/.env.production
            cp /var/www/env/admin.frontend.env /var/www/website-admin/frontend/.env 
            cp /var/www/env/admin.frontend.env /var/www/website-admin/frontend/.env.production 
          EOF

  deploy-backend:
    runs-on: ubuntu-latest
    needs: project-prepare

    steps:
      # - name: ğŸ›ï¸ Checkout code
      #   uses: actions/checkout@v4

      - name: ğŸ§ Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      - name: ğŸ³ Deploy backend with Docker
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} << 'EOF'
            echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login ${{ secrets.ALIYUN_REGISTRY_SERVER }} \
              -u ${{ secrets.ALIYUN_REGISTRY_USERNAME }} --password-stdin
            
            cd /var/www/website-admin
            
            echo "ğŸ›‘ Stopping backend container..."
            sudo docker compose stop backend || true
            sudo docker compose rm -f backend || true

            echo "ğŸ³ Building backend Docker image..."
            sudo docker compose build backend

            echo "ğŸš€ Starting backend container..."
            sudo docker compose up -d backend

            echo "â³ Waiting for backend to start..."
            sleep 5

            echo "ğŸ§± Running migrations..."
            sudo docker compose run --rm backend python manage.py migrate

            echo "âœ… Backend deployment completed!"
          EOF

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [project-prepare, deploy-backend]
    steps:
      # - name: ğŸ›ï¸ Checkout code
      #   uses: actions/checkout@v4

      - name: ğŸ§ Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      - name: ğŸ³ Build and deploy frontend with Docker (detached)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} << 'EOF'
            echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login ${{ secrets.ALIYUN_REGISTRY_SERVER }} \
              -u ${{ secrets.ALIYUN_REGISTRY_USERNAME }} --password-stdin
            
            cd /var/www/website-admin
            
            echo "ğŸ›‘ Stopping frontend container..."
            sudo docker compose stop frontend || true
            sudo docker compose rm -f frontend || true

            echo "ğŸ³ Building frontend Docker image in background..."
            nohup sudo docker compose build frontend > /tmp/frontend-build.log 2>&1 &
            BUILD_PID=$!
            
            echo "â³ Waiting for frontend build to complete..."
            tail -f /tmp/frontend-build.log &
            TAIL_PID=$!
            
            wait $BUILD_PID
            BUILD_EXIT_CODE=$?
            
            kill $TAIL_PID 2>/dev/null || true
            
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "âŒ Frontend build failed!"
              cat /tmp/frontend-build.log
              exit 1
            fi

            echo "ğŸš€ Starting frontend container..."
            sudo docker compose up -d frontend

            echo "âœ… Frontend deployment completed!"
          EOF
