name: Deploy to Aliyun

on:
  push:
    branches:
      - main

jobs:
  # 1. ä¸¥æ ¼çš„ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: cd frontend && npm ci

      - name: ğŸ” ESLint Check
        run: |
          cd frontend
          echo "Running ESLint..."
          npm run lint

      - name: ğŸ” TypeScript Type Check
        run: |
          cd frontend
          echo "Running TypeScript type check..."
          npm run type-check

      - name: âœ… Quality Check Passed
        run: echo "All quality checks passed! Proceeding with deployment..."

  # 2. å‡†å¤‡é¡¹ç›®ï¼ˆåªæœ‰æ£€æŸ¥é€šè¿‡æ‰æ‰§è¡Œï¼‰
  project-prepare:
    runs-on: ubuntu-latest
    needs: code-quality # å…³é”®ï¼šä¾èµ–æ£€æŸ¥é€šè¿‡
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§ Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      - name: ğŸ“¤ Copy project to Aliyun
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/var/www/website-admin

      - name: ğŸ§¾ Prepare .env files
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} << 'EOF'
            cp /var/www/env/admin.env /var/www/website-admin/backend/.env
            cp /var/www/env/admin.env /var/www/website-admin/backend/.env.production
            cp /var/www/env/admin.frontend.env /var/www/website-admin/frontend/.env 
            cp /var/www/env/admin.frontend.env /var/www/website-admin/frontend/.env.production 
          EOF

  # 3. éƒ¨ç½²åç«¯
  deploy-backend:
    runs-on: ubuntu-latest
    needs: project-prepare
    steps:
      - name: ğŸ§ Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      - name: ğŸ³ Deploy Backend
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} << 'EOF'
            echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login ${{ secrets.ALIYUN_REGISTRY_SERVER }} \
              -u ${{ secrets.ALIYUN_REGISTRY_USERNAME }} --password-stdin
            
            cd /var/www/website-admin
            
            sudo docker compose stop backend || true
            sudo docker compose rm -f backend || true
            sudo docker compose build backend
            sudo docker compose up -d backend
            
            sleep 5
            sudo docker compose exec -T backend python manage.py migrate
            
            echo "âœ… Backend deployed!"
          EOF

  # 4. éƒ¨ç½²å‰ç«¯
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [project-prepare, deploy-backend]
    steps:
      - name: ğŸ§ Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      - name: ğŸ³ Deploy Frontend
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=6000 \
              -o TCPKeepAlive=yes \
              ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} << 'EOF'
            set -e
            
            echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login ${{ secrets.ALIYUN_REGISTRY_SERVER }} \
              -u ${{ secrets.ALIYUN_REGISTRY_USERNAME }} --password-stdin
            
            cd /var/www/website-admin
            
            sudo docker compose stop frontend || true
            sudo docker compose rm -f frontend || true
            
            DOCKER_BUILDKIT=1 sudo docker compose build frontend
            sudo docker compose up -d frontend
            
            sleep 10
            echo "âœ… Frontend deployed!"
          EOF
